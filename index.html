<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>입지 평가 자동 분석</title>
  <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=569dd4860d5c50fec04894c349779ea1&libraries=services"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
    h1 { color: #1e88e5; }
    input { padding: 8px; margin-bottom: 10px; width: 300px; }
    button { padding: 8px 16px; background: #1e88e5; color: white; border: none; cursor: pointer; }
    #map { width: 100%; height: 400px; margin-top: 20px; }
    .result { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>입지 평가 자동 분석</h1>
  <input type="text" id="address" placeholder="주소를 입력하세요 (예: 서울 강남구 테헤란로 123)">
  <button onclick="searchLocation()">분석 시작</button>

  <div id="map"></div>
  <div class="result">
    <h2>총점: <span id="score">0</span> / 15</h2>
    <canvas id="chart"></canvas>
  </div>

  <script>
    let map, marker, ps, geocoder;

    function searchLocation() {
      const address = document.getElementById("address").value;
      geocoder = new kakao.maps.services.Geocoder();
      geocoder.addressSearch(address, function(result, status) {
        if (status === kakao.maps.services.Status.OK) {
          const lat = parseFloat(result[0].y);
          const lng = parseFloat(result[0].x);
          const location = new kakao.maps.LatLng(lat, lng);
          showMap(location);
          analyzeLocation(location);
        } else {
          alert("주소를 찾을 수 없습니다.");
        }
      });
    }

    function showMap(latlng) {
      const container = document.getElementById('map');
      const options = { center: latlng, level: 3 };
      map = new kakao.maps.Map(container, options);
      if (marker) marker.setMap(null);
      marker = new kakao.maps.Marker({ position: latlng });
      marker.setMap(map);
      ps = new kakao.maps.services.Places();
    }

    function analyzeLocation(latlng) {
      const scores = { 단지: 0, 인프라: 0, 초등학교: 0 };

      const units = prompt("본건 + 인접 단지 세대수 입력 (숫자):", "1500");
      const totalUnits = parseInt(units);
      if (totalUnits > 2000) scores["단지"] = 5;
      else if (totalUnits > 1000) scores["단지"] = 4;
      else if (totalUnits > 500) scores["단지"] = 3;
      else if (totalUnits > 300) scores["단지"] = 2;
      else scores["단지"] = 1;

      let infraCount = 0;
      const types = ["이마트", "병원", "행정복지센터"];
      let completed = 0;
      types.forEach(keyword => {
        ps.keywordSearch(keyword, function(data, status) {
          if (status === kakao.maps.services.Status.OK) {
            const nearby = data.filter(place => {
              const d = getDistance(latlng.getLat(), latlng.getLng(), place.y, place.x);
              return d <= 1000;
            });
            infraCount += nearby.length;
          }
          completed++;
          if (completed === types.length) {
            if (infraCount >= 6) scores["인프라"] = 5;
            else if (infraCount >= 4) scores["인프라"] = 4;
            else if (infraCount >= 2) scores["인프라"] = 3;
            else if (infraCount >= 1) scores["인프라"] = 2;
            else scores["인프라"] = 1;
            checkSchool();
          }
        }, { location: latlng, radius: 1000 });
      });

      function checkSchool() {
        ps.keywordSearch("초등학교", function(data, status) {
          if (status === kakao.maps.services.Status.OK) {
            const sorted = data.map(place => ({
              dist: getDistance(latlng.getLat(), latlng.getLng(), place.y, place.x)
            })).sort((a, b) => a.dist - b.dist);

            const distance = sorted[0]?.dist || 9999;
            if (distance <= 300) scores["초등학교"] = 5;
            else if (distance <= 500) scores["초등학교"] = 4;
            else if (distance <= 700) scores["초등학교"] = 3;
            else if (distance <= 1000) scores["초등학교"] = 2;
            else scores["초등학교"] = 1;

            drawChart(scores);
          }
        }, { location: latlng, radius: 1000 });
      }
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const φ1 = lat1 * Math.PI/180;
      const φ2 = lat2 * Math.PI/180;
      const Δφ = (lat2-lat1) * Math.PI/180;
      const Δλ = (lon2-lon1) * Math.PI/180;
      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function drawChart(scores) {
      const total = scores["단지"] + scores["인프라"] + scores["초등학교"];
      document.getElementById("score").innerText = total;
      const ctx = document.getElementById("chart").getContext("2d");
      if (window.myChart) window.myChart.destroy();
      window.myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ["주거단지 규모", "1km 내 인프라", "초등학교 접근성"],
          datasets: [{
            label: "항목별 점수",
            data: [scores["단지"], scores["인프라"], scores["초등학교"]],
            backgroundColor: ["#42a5f5", "#66bb6a", "#ffca28"]
          }]
        },
        options: {
          scales: { y: { beginAtZero: true, max: 5 } }
        }
      });
    }
  </script>
</body>
</html>